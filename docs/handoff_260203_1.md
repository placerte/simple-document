# handoff\_260203\_1.md — simdoc v0 (working name) — Locked specs

> **Scope:** early specification for the v0 “boring core” of **simdoc**.
>
> **Format:** uniquely-identified decisions. Specs are stable unless explicitly re-opened.

---

## Specs

### Core mental model

- **S-260203\_1-1** — The document is an **append-only** ordered list of blocks.
- **S-260203\_1-1.1** — All core API methods **append** blocks (no insert/move/reorder in v0).
- **S-260203\_1-1.2** — No AST/editor model in v0; editing features are out of scope.

### Public API shape

- **S-260203\_1-2** — Public API uses **explicit convenience methods** on the document object.
- **S-260203\_1-2.1** — Core methods include: `h1..h6`, `h(level, text)`, `p(text)`, `ul(items)`, `ol(items)`, `code(text, lang=None)`, `table(...)`, `hr()` , plus `to_markdown()`.
- **S-260203\_1-2.2** — No exposed block classes or `add(Block)` mechanism in v0.
- **S-260203\_1-2.3** — API favors readability/immediacy; extension points are deferred.

### Deterministic formatting rules

- **S-260203\_1-3** — simdoc output is fully **deterministic** by default.
- **S-260203\_1-3.1** — Exactly **one blank line** between all top-level blocks.
- **S-260203\_1-3.2** — Documents end with **exactly one** trailing newline (`\n`).
- **S-260203\_1-3.3** — **No automatic line wrapping**.
- **S-260203\_1-3.4** — Newlines are normalized to `\n` internally.

### Internal representation

- **S-260203\_1-4** — Internally, a document is an ordered list of **private block records**, not raw Markdown strings.
- **S-260203\_1-4.1** — Blocks are only created via builder API (no Markdown parsing).
- **S-260203\_1-4.2** — `to_markdown()` is the canonical renderer in v0; formatting/escaping/spacing is enforced centrally.
- **S-260203\_1-4.3** — Future exports may either render from block records or use Markdown as an intermediate.

### Code blocks

- **S-260203\_1-5** — `doc.code(...)` must always render **valid Markdown**, regardless of code content.
- **S-260203\_1-5.1** — Auto-select a **safe fence** for `to_markdown()`.
- **S-260203\_1-5.2** — Escalate fence length as needed (deterministic).
- **S-260203\_1-5.3** — Optional language tag, passed through verbatim (no validation in v0).
- **S-260203\_1-5.4** — Normalize newlines to `\n`, otherwise preserve code content exactly.

### Tables

- **S-260203\_1-6.1** — Tables render as **GFM pipe tables**.
- **S-260203\_1-6.2** — Alignment supported but optional.
- **S-260203\_1-6.2.1** — Default alignment is **left** for all columns.
- **S-260203\_1-6.3** — Table rendering must always emit **valid GFM**.
- **S-260203\_1-6.3.1** — Escape pipes in cells: `| → \|`.
- **S-260203\_1-6.3.2** — Newlines inside cells become literal `<br>`.
- **S-260203\_1-6.3.3** — No other mutation (no trimming/wrapping/sanitizing beyond validity).
- **S-260203\_1-6.3.4** — Non-string cell values stringified via `str(x)`; `None` becomes empty cell.
- **S-260203\_1-6.4** — `doc.table()` accepts both list-of-lists and list-of-dicts.
- **S-260203\_1-6.4.1** — For list-of-dicts: if `headers` provided, it defines order; else column keys are **sorted deterministically**.

### Lists

- **S-260203\_1-7** — Deterministic Markdown lists supported.
- **S-260203\_1-7.1** — Unordered list marker always `-`.
- **S-260203\_1-7.2** — Ordered lists always use `1.` for each item.
- **S-260203\_1-7.3** — Nested lists supported via nested Python lists.
- **S-260203\_1-7.4** — No blank lines between list items.

### Headings

- **S-260203\_1-8.1** — Always ATX headings (`#`, `##`, …).
- **S-260203\_1-8.2** — Support heading levels h1..h6 only.
- **S-260203\_1-8.3** — Heading text is single-line; internal newlines normalized to spaces.
- **S-260203\_1-8.4** — Provide both `h1..h6()` and `h(level, text)`.
- **S-260203\_1-8.4.1** — `h(level, text)` validates level in `[1..6]`.

### Paragraphs

- **S-260203\_1-9.1** — `p(text)` treats input as a single paragraph; no splitting on blank lines.
- **S-260203\_1-9.2** — No inline formatting helpers (user supplies inline Markdown).
- **S-260203\_1-9.3** — Preserve internal newlines (after newline normalization).
- **S-260203\_1-9.4** — Empty/whitespace-only paragraphs are ignored.

### Horizontal rules & callouts

- **S-260203\_1-10.1** — Horizontal rules are supported via `doc.hr()`.
- **S-260203\_1-10.2** — Horizontal rules render using a fixed style: `---`.
- **S-260203\_1-10.3** — No callout / admonition concept in v0.

---

### Export & I/O

- **S-260203\_1-11.1** — Core export surface includes:

  - `to_markdown() -> str` (canonical renderer)
  - `save(path)` convenience method for writing Markdown to disk

- **S-260203\_1-11.1.1** — `save(path)` defaults:

  - UTF-8 encoding
  - `\n` newlines
  - creates parent directories if missing
  - overwrites existing files by default

- **S-260203\_1-11.2.1** — Atomic writes are **not** supported in v0 (deferred).

- **S-260203\_1-11.2.2** — `save(path)` returns the written **`Path`** on success.

- **S-260203\_1-11.2.3** — `save(path)` raises standard Python I/O exceptions on failure.

### Export adapters (v0 scope)

- **S-260203\_1-12.1** — v0 export scope is **Markdown only**.

  - No built-in HTML or PDF adapters in v0.
  - Future adapters remain feasible due to the internal block record representation.

- **S-260203\_1-12.2** — When adapters are introduced, they will be provided via **optional extras** on the core package (e.g. `simdoc[html]`, `simdoc[pdf]`).

---

## Implementation

### I-260203\_1-1 — Project structure

The project follows a **minimal, layered layout** separating public API, internal block models, and rendering logic.

```
simdoc/
├─ src/
│  └─ simdoc/
│     ├─ __init__.py        # Public API (Document class, convenience functions)
│     ├─ document.py        # Document builder (append-only, user-facing methods)
│     ├─ blocks.py          # Private block record definitions (internal only)
│     ├─ render/
│     │  ├─ __init__.py
│     │  └─ markdown.py     # Markdown renderer (to_markdown implementation)
│     └─ util/
│        ├─ __init__.py
│        └─ text.py         # Escaping, fence selection, newline normalization
│
├─ tests/
│  ├─ test_markdown_golden.py
│  ├─ test_blocks.py
│  └─ fixtures/
│     └─ expected_md/
│
├─ pyproject.toml
├─ README.md
└─ LICENSE
```

### I-260203\_1-2 — Module responsibilities

- **document.py**

  - Owns the `Doc` class
  - Implements public builder methods (`h1`, `p`, `code`, `table`, …)
  - Performs light input normalization and validation
  - Appends private block records to the document

- **blocks.py**

  - Defines minimal, immutable block record types (e.g. dataclasses)
  - No rendering logic
  - Not part of the public API

- **render/markdown.py**

  - Pure functions to render block records into Markdown
  - Enforces all deterministic formatting rules
  - Owns fence selection, table formatting, list rendering, spacing rules

- **util/text.py**

  - Small helpers for:
    - newline normalization
    - escaping pipes
    - safe fence computation
  - No knowledge of blocks or document structure

### I-260203\_1-3 — Public API boundary

- Only symbols exported in `simdoc/__init__.py` are considered public.
- All other modules are **internal and subject to change**.
- Rendering helpers and block definitions are explicitly non-public.

---

## Implementation

### Project layout

- **I-260203\_1-1** — Use a standard `src/` layout.

```text
simdoc/
├─ pyproject.toml
├─ README.md
├─ LICENSE
├─ src/
│  └─ simdoc/
│     ├─ __init__.py
│     ├─ doc.py
│     ├─ _blocks.py
│     ├─ _render/
│     │  ├─ __init__.py
│     │  └─ markdown.py
│     └─ _io.py
└─ tests/
   ├─ test_golden_markdown.py
   ├─ test_code_fences.py
   ├─ test_tables.py
   ├─ test_lists.py
   └─ fixtures/
      └─ golden/
         ├─ basic.md
         ├─ code_fences.md
         ├─ tables.md
         └─ lists.md
```

### Module responsibilities

- **I-260203\_1-2** — `simdoc.doc` contains the public document class and builder methods.
- **I-260203\_1-3** — `simdoc._blocks` defines private block records (small dataclasses) for:
  - Heading, Paragraph, ListBlock, CodeBlock, TableBlock, Hr
- **I-260203\_1-4** — `simdoc._render.markdown` implements `render_markdown(blocks) -> str` and all Markdown rules.
- **I-260203\_1-5** — `simdoc._render.markdown` centralizes escaping/normalization helpers:
  - safe code fence selection + escalation
  - table cell escaping + newline→`<br>`
  - heading newline→space normalization
- **I-260203\_1-6** — `simdoc._io` implements `save_markdown(text: str, path: PathLike) -> Path` with v0 defaults.
- **I-260203\_1-7** — `simdoc.__init__` exports only the public surface. Private modules remain private.

### Testing approach

- **I-260203\_1-8** — Golden-file tests assert deterministic output by comparing to `tests/fixtures/golden/*.md`.
- **I-260203\_1-9** — Focused unit tests cover:
  - code fence safety (embedded \`\`\` sequences)
  - table escaping (pipes, newlines)
  - nested list rendering

---

## Definition of Done

- **DoD-260203\_1-1** — Public API exists and is documented in README:

  - `Doc`
  - `h1..h6`, `h(level, text)`
  - `p(text)`
  - `ul(items)`, `ol(items)` (including nested lists)
  - `code(text, lang=None)`
  - `table(...)` (list-of-lists and list-of-dicts)
  - `hr()`
  - `to_markdown() -> str`
  - `save(path) -> Path`

- **DoD-260203\_1-2** — Output guarantees are met for all block types:

  - deterministic formatting
  - exactly one blank line between blocks
  - no automatic line wrapping
  - exactly one trailing `
    `
  - internal newline normalization to `
    `

- **DoD-260203\_1-3** — Code fences are always safe:

  - renderer escalates fence length deterministically
  - resulting Markdown is valid regardless of code content

- **DoD-260203\_1-4** — Tables are always valid GFM pipe tables:

  - pipes escaped (`|` → `\|`)
  - cell newlines become `<br>`
  - deterministic header order for list-of-dicts (sorted keys when headers not provided)
  - `None` becomes empty cell; other values use `str(x)`

- **DoD-260203\_1-5** — Lists are deterministic:

  - unordered marker is always `-`
  - ordered lists always use `1.` per item
  - nested lists render deterministically from nested Python lists

- **DoD-260203\_1-6** — Validation and error model is implemented as locked:

  - permissive-by-default inputs where deterministic rendering is possible
  - builder methods do light normalization / cheap sanity checks
  - renderer is final authority
  - single custom exception base `SimDocError` for document/render issues
  - standard Python exceptions for I/O

- **DoD-260203\_1-7** — Mutability & ergonomics:

  - `Doc` is reusable/appendable after rendering
  - builder methods return `None`
  - `len(doc)` returns block count (optional `block_count` alias)
  - `repr(doc)` is concise/stable (e.g. `Doc(blocks=7)`)

- **DoD-260203\_1-8** — Packaging and minimal quality gates:

  - clean `src/` layout
  - type hints on public API
  - passes unit tests on supported Python versions

---

## Tests

- **T-260203\_1-1** — Golden Markdown determinism tests

  - Compare `Doc(...).to_markdown()` against `tests/fixtures/golden/*.md`.
  - Include at least: `basic.md`, `lists.md`, `tables.md`, `code_fences.md`.

- **T-260203\_1-2** — Code fence escalation tests

  - Inputs containing \`\`\` (and longer backtick runs) must render with a longer fence.
  - Ensure determinism: same input always produces same fence length.

- **T-260203\_1-3** — Table escaping tests

  - Pipes in cells are escaped.
  - Newlines in cells become `<br>`.
  - `None` renders as empty.
  - List-of-dicts column ordering is deterministic.

- **T-260203\_1-4** — List rendering tests

  - `ul` uses `-`.
  - `ol` uses `1.` for all items.
  - Nested list structures render correctly and deterministically.

- **T-260203\_1-5** — Spacing and newline invariants

  - Exactly one blank line between blocks.
  - Exactly one trailing newline.
  - No implicit line wrapping.

- **T-260203\_1-6** — I/O smoke tests

  - `save(path)` writes UTF-8 with `
    ` newlines.
  - Parent directories are created.
  - Overwrites existing file.
  - Returns `Path`.

